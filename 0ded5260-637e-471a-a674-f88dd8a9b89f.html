<!DOCTYPE html>
<html>

<head>
  <style>
    /* Global white color override for non-auto-contrast elements */
    *:not(.auto-contrast-text) {
      color: white !important;
    }

    html {
      height: 100%;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI Variable Display', 'Segoe UI', Helvetica, 'Apple Color Emoji', Arial, sans-serif, 'Segoe UI Emoji', 'Segoe UI Symbol';
    }

    body {
      /* background-color: rgb(25, 25, 25); */
      background-color: rgb(255, 255, 255);
      margin: 0;
      padding: 0px;
    }

    .feedback-widget {
      display: inline-flex;
      align-items: center;
      padding: 0px 12px 0px 0px;
    }

    /* Ensure auto-contrast text color overrides take precedence */
    .auto-contrast-text,
    .auto-contrast-text * {
      color: inherit !important;
      font-weight: 500;
    }

    /* Notion theme support - try to inherit theme colors if available */
    .notion-theme-aware {
      background-color: var(--notion-bg-color, var(--notion-theme-bg, inherit));
      color: var(--notion-text-color, var(--notion-theme-text, inherit));
    }

    /* Enhanced auto-contrast with Notion theme fallbacks */
    .auto-contrast-text.notion-enhanced {
      /* Use Notion theme colors if available, fallback to auto-calculation */
      color: var(--notion-auto-text-color, inherit);
    }
  </style>
</head>

<body class="page-body ">
  <div class="feedback-widget auto-contrast-text notion-enhanced">
    <span>Just let me know if you think this is helpful.</span>
    <span data-lyket-type="like" data-lyket-id="0ded5260-637e-471a-a674-f88dd8a9b89f" data-lyket-namespace="notion"
      data-lyket-template="twitter"></span>
  </div>
  <script src="https://unpkg.com/@lyket/widget@latest/dist/lyket.js?apiKey=pt_c791403c654b27c63cd0926a8d1f37"></script>

  <script>
    // Function to calculate if a color is light or dark
    function getContrastYIQ(r, g, b) {
      // YIQ formula for luminance
      var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
      return (yiq >= 128) ? 'light' : 'dark';
    }

    // Function to get RGB values from any CSS color format
    function getRGB(color) {
      // Create a temporary element to get computed style
      var tempDiv = document.createElement('div');
      tempDiv.style.color = color;
      document.body.appendChild(tempDiv);
      var computedColor = window.getComputedStyle(tempDiv).color;
      document.body.removeChild(tempDiv);

      // Parse RGB values
      var rgbMatch = computedColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (rgbMatch) {
        return {
          r: parseInt(rgbMatch[1]),
          g: parseInt(rgbMatch[2]),
          b: parseInt(rgbMatch[3])
        };
      }
      return { r: 0, g: 0, b: 0 };
    }

    // Enhanced function to detect Notion theme colors
    function detectNotionTheme() {
      var theme = {
        background: null,
        text: null,
        isDark: false
      };

      try {
        // Try to access parent document styles (may be restricted in iframe)
        if (window.parent && window.parent.document) {
          var parentBody = window.parent.document.body;
          var parentStyles = window.getComputedStyle(parentBody);

          if (parentStyles) {
            theme.background = parentStyles.backgroundColor;
            theme.text = parentStyles.color;

            // Determine if dark theme based on background
            if (theme.background !== 'rgba(0, 0, 0, 0)' && theme.background !== 'transparent') {
              var rgbMatch = theme.background.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
              if (rgbMatch) {
                var yiq = ((parseInt(rgbMatch[1]) * 299) + (parseInt(rgbMatch[2]) * 587) + (parseInt(rgbMatch[3]) * 114)) / 1000;
                theme.isDark = yiq < 128;
              }
            }
          }
        }
      } catch (e) {
        console.log('Could not access parent document (iframe restriction):', e.message);
      }

      return theme;
    }

    // Enhanced function to apply auto-contrast with Notion theme support
    function applyAutoContrast() {
      var elements = document.querySelectorAll('.auto-contrast-text');
      var notionTheme = detectNotionTheme();

      elements.forEach(function (element) {
        var finalColor = null;

        // First, try to use Notion theme if available and element is theme-aware
        if (element.classList.contains('notion-enhanced') && notionTheme.background) {
          var rgbMatch = notionTheme.background.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
          if (rgbMatch) {
            var r = parseInt(rgbMatch[1]);
            var g = parseInt(rgbMatch[2]);
            var b = parseInt(rgbMatch[3]);
            var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            var contrast = (yiq >= 128) ? 'light' : 'dark';
            finalColor = contrast === 'dark' ? 'white' : 'black';

            console.log('Using Notion theme - Background:', notionTheme.background, 'Text color:', finalColor);
          }
        }

        // Fallback to original logic if no theme color determined
        if (!finalColor) {
          // Get the background color of the element itself
          var elementBgColor = window.getComputedStyle(element).backgroundColor;

          // If element has no background, check parent elements
          var bgColor = elementBgColor;
          if (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent') {
            // Check parent elements for background color
            var parent = element.parentElement;
            while (parent && (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent')) {
              bgColor = window.getComputedStyle(parent).backgroundColor;
              parent = parent.parentElement;
            }
          }

          if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
            // Parse RGB values directly from computed style
            var rgbMatch = bgColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (rgbMatch) {
              var r = parseInt(rgbMatch[1]);
              var g = parseInt(rgbMatch[2]);
              var b = parseInt(rgbMatch[3]);
              var yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
              var contrast = (yiq >= 128) ? 'light' : 'dark';
              finalColor = contrast === 'dark' ? 'white' : 'black';

              console.log('Using local background - Background:', bgColor, 'Text color:', finalColor);
            } else {
              console.log('Could not parse background color:', bgColor, 'for element:', element.className);
            }
          } else {
            console.log('No background color found for element:', element.className);
          }
        }

        // Apply the determined color
        if (finalColor) {
          element.style.setProperty('color', finalColor, 'important');
        }
      });
    }

    // Listen for Notion theme changes via PostMessage API
    window.addEventListener('message', function(event) {
      // Verify origin for security (adjust as needed for Notion domains)
      if (event.origin.includes('notion.so') || event.origin.includes('notion.site')) {
        if (event.data && event.data.type === 'themeChange') {
          console.log('Notion theme change detected:', event.data);
          setTimeout(applyAutoContrast, 100);
        }
      }
    });

    // Watch for changes in parent container styles (when possible)
    function watchForThemeChanges() {
      try {
        if (window.parent && window.parent.document) {
          var observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                console.log('Parent style change detected');
                applyAutoContrast();
              }
            });
          });

          observer.observe(window.parent.document.body, {
            attributes: true,
            attributeFilter: ['style']
          });
        }
      } catch (e) {
        console.log('Could not set up parent observer (iframe restriction)');
      }
    }

    // Apply auto-contrast when page loads
    document.addEventListener('DOMContentLoaded', function () {
      applyAutoContrast();
      watchForThemeChanges();
    });

    // Apply auto-contrast when Lyket widget loads (in case it changes colors)
    document.addEventListener('DOMNodeInserted', function () {
      setTimeout(applyAutoContrast, 100);
    });

    // Make functions globally available for manual testing
    window.testAutoContrast = applyAutoContrast;
    window.detectNotionTheme = detectNotionTheme;
  </script>
</body>

</html>
